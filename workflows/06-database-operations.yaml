apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: database-operations
  namespace: argo
  annotations:
    description: "Database operations workflow - connect, test queries, create users, execute dynamic SQL (PostgreSQL)"
spec:
  entrypoint: database-pipeline
  serviceAccountName: argo-workflow
  
  # Workflow parameters
  arguments:
    parameters:
    - name: db-host
      default: "postgresql.default.svc.cluster.local"
    - name: db-port
      default: "5432"
    - name: db-name
      default: "testdb"
    - name: db-admin-user
      default: "postgres"
    - name: db-admin-password
      default: ""  # Should come from secret
    - name: new-username
      default: "testuser"
    - name: new-user-password
      default: ""  # Will be generated if empty
    - name: new-user-database
      default: "testdb"  # Database to grant access to
    - name: custom-query
      default: "SELECT version();"  # Custom SQL query to execute
  
  templates:
  - name: database-pipeline
    steps:
    # Step 1: Test database connection
    - - name: test-connection
        template: test-db-connection
        arguments:
          parameters:
          - name: db-host
            value: "{{workflow.parameters.db-host}}"
          - name: db-port
            value: "{{workflow.parameters.db-port}}"
          - name: db-name
            value: "{{workflow.parameters.db-name}}"
          - name: db-admin-user
            value: "{{workflow.parameters.db-admin-user}}"
          - name: db-admin-password
            value: "{{workflow.parameters.db-admin-password}}"
    
    # Step 2: Execute dynamic queries
    - - name: run-dynamic-queries
        template: execute-sql-queries
        arguments:
          parameters:
          - name: db-host
            value: "{{workflow.parameters.db-host}}"
          - name: db-port
            value: "{{workflow.parameters.db-port}}"
          - name: db-name
            value: "{{workflow.parameters.db-name}}"
          - name: db-admin-user
            value: "{{workflow.parameters.db-admin-user}}"
          - name: db-admin-password
            value: "{{workflow.parameters.db-admin-password}}"
          - name: custom-query
            value: "{{workflow.parameters.custom-query}}"
    
    # Step 3: Create database user
    - - name: create-user
        template: create-db-user
        arguments:
          parameters:
          - name: db-host
            value: "{{workflow.parameters.db-host}}"
          - name: db-port
            value: "{{workflow.parameters.db-port}}"
          - name: db-admin-user
            value: "{{workflow.parameters.db-admin-user}}"
          - name: db-admin-password
            value: "{{workflow.parameters.db-admin-password}}"
          - name: new-username
            value: "{{workflow.parameters.new-username}}"
          - name: new-user-password
            value: "{{workflow.parameters.new-user-password}}"
          - name: new-user-database
            value: "{{workflow.parameters.new-user-database}}"
    
    # Step 4: Test new user connection
    - - name: test-new-user
        template: test-user-connection
        arguments:
          parameters:
          - name: db-host
            value: "{{workflow.parameters.db-host}}"
          - name: db-port
            value: "{{workflow.parameters.db-port}}"
          - name: db-name
            value: "{{workflow.parameters.new-user-database}}"
          - name: username
            value: "{{workflow.parameters.new-username}}"
          - name: password
            value: "{{workflow.parameters.new-user-password}}"

  # Template: Test database connection
  - name: test-db-connection
    inputs:
      parameters:
      - name: db-host
      - name: db-port
      - name: db-name
      - name: db-admin-user
      - name: db-admin-password
    container:
      image: postgres:15-alpine
      command: [sh, -c]
      env:
      - name: PGHOST
        value: "{{inputs.parameters.db-host}}"
      - name: PGPORT
        value: "{{inputs.parameters.db-port}}"
      - name: PGDATABASE
        value: "{{inputs.parameters.db-name}}"
      - name: PGUSER
        value: "{{inputs.parameters.db-admin-user}}"
      - name: PGPASSWORD
        value: "{{inputs.parameters.db-admin-password}}"
      args:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”Œ Testing Database Connection"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Host: $PGHOST"
        echo "Port: $PGPORT"
        echo "Database: $PGDATABASE"
        echo "User: $PGUSER"
        echo ""
        
        echo "â³ Connecting to PostgreSQL..."
        if psql -c "SELECT version();" > /dev/null 2>&1; then
          echo "âœ… PostgreSQL connection successful!"
          echo ""
          echo "ğŸ“Š Database Information:"
          psql -c "SELECT version();"
          echo ""
          psql -c "SELECT current_database(), current_user, inet_server_addr(), inet_server_port();"
        else
          echo "âŒ PostgreSQL connection failed!"
          exit 1
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Connection test completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Template: Execute dynamic SQL queries
  - name: execute-sql-queries
    inputs:
      parameters:
      - name: db-host
      - name: db-port
      - name: db-name
      - name: db-admin-user
      - name: db-admin-password
      - name: custom-query
    container:
      image: postgres:15-alpine
      command: [sh, -c]
      env:
      - name: PGHOST
        value: "{{inputs.parameters.db-host}}"
      - name: PGPORT
        value: "{{inputs.parameters.db-port}}"
      - name: PGDATABASE
        value: "{{inputs.parameters.db-name}}"
      - name: PGUSER
        value: "{{inputs.parameters.db-admin-user}}"
      - name: PGPASSWORD
        value: "{{inputs.parameters.db-admin-password}}"
      - name: CUSTOM_QUERY
        value: "{{inputs.parameters.custom-query}}"
      args:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ Executing Dynamic SQL Queries"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        echo "1ï¸âƒ£  Listing all databases:"
        psql -c "\l" || true
        echo ""
        
        echo "2ï¸âƒ£  Listing all tables in current database:"
        psql -c "\dt" || true
        echo ""
        
        echo "3ï¸âƒ£  Showing current database size:"
        psql -c "SELECT pg_size_pretty(pg_database_size(current_database())) AS database_size;" || true
        echo ""
        
        echo "4ï¸âƒ£  Listing all users/roles:"
        psql -c "\du" || true
        echo ""
        
        echo "5ï¸âƒ£  Custom query: $CUSTOM_QUERY"
        psql -c "$CUSTOM_QUERY" || true
        echo ""
        
        echo "6ï¸âƒ£  Example: Create a test table (if not exists):"
        psql -c "
          CREATE TABLE IF NOT EXISTS workflow_test (
            id SERIAL PRIMARY KEY,
            workflow_name VARCHAR(255),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            status VARCHAR(50)
          );
        " || true
        
        echo "7ï¸âƒ£  Example: Insert test data:"
        psql -c "
          INSERT INTO workflow_test (workflow_name, status)
          VALUES ('{{workflow.name}}', 'running')
          ON CONFLICT DO NOTHING;
        " || true
        
        echo "8ï¸âƒ£  Example: Query test data:"
        psql -c "SELECT * FROM workflow_test ORDER BY created_at DESC LIMIT 5;" || true
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… SQL queries executed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Template: Create database user
  - name: create-db-user
    inputs:
      parameters:
      - name: db-host
      - name: db-port
      - name: db-admin-user
      - name: db-admin-password
      - name: new-username
      - name: new-user-password
      - name: new-user-database
    container:
      image: postgres:15-alpine
      command: [sh, -c]
      env:
      - name: PGHOST
        value: "{{inputs.parameters.db-host}}"
      - name: PGPORT
        value: "{{inputs.parameters.db-port}}"
      - name: PGDATABASE
        value: "postgres"  # Connect to postgres DB to create users
      - name: PGUSER
        value: "{{inputs.parameters.db-admin-user}}"
      - name: PGPASSWORD
        value: "{{inputs.parameters.db-admin-password}}"
      - name: NEW_USERNAME
        value: "{{inputs.parameters.new-username}}"
      - name: NEW_USER_PASSWORD
        value: "{{inputs.parameters.new-user-password}}"
      - name: NEW_USER_DATABASE
        value: "{{inputs.parameters.new-user-database}}"
      args:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‘¤ Creating Database User"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Username: $NEW_USERNAME"
        echo "Database: $NEW_USER_DATABASE"
        echo ""
        
        # Generate password if not provided
        USER_PASSWORD="$NEW_USER_PASSWORD"
        if [ -z "$USER_PASSWORD" ]; then
          USER_PASSWORD=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
          echo "ğŸ”‘ Generated password: ${USER_PASSWORD}"
        else
          echo "ğŸ”‘ Using provided password"
        fi
        
        echo "â³ Creating PostgreSQL user..."
        
        # Check if user exists
        USER_EXISTS=$(psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='$NEW_USERNAME'")
        
        if [ "$USER_EXISTS" = "1" ]; then
          echo "âš ï¸  User '$NEW_USERNAME' already exists, updating password..."
          psql -c "ALTER USER $NEW_USERNAME WITH PASSWORD '${USER_PASSWORD}';" || exit 1
        else
          echo "â• Creating new user..."
          psql -c "CREATE USER $NEW_USERNAME WITH PASSWORD '${USER_PASSWORD}';" || exit 1
        fi
        
        # Grant privileges on database
        echo "ğŸ” Granting privileges on database '$NEW_USER_DATABASE'..."
        psql -c "GRANT ALL PRIVILEGES ON DATABASE $NEW_USER_DATABASE TO $NEW_USERNAME;" || true
        
        # Connect to the target database and grant schema privileges
        export PGDATABASE="$NEW_USER_DATABASE"
        psql -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $NEW_USERNAME;" || true
        psql -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $NEW_USERNAME;" || true
        psql -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $NEW_USERNAME;" || true
        
        echo "âœ… PostgreSQL user created successfully!"
        echo ""
        echo "ğŸ“‹ User details:"
        export PGDATABASE="postgres"
        psql -c "\du $NEW_USERNAME"
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… User creation completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“ Connection details for new user:"
        echo "   Host: $PGHOST"
        echo "   Port: $PGPORT"
        echo "   Database: $NEW_USER_DATABASE"
        echo "   Username: $NEW_USERNAME"
        echo "   Password: ${USER_PASSWORD}"
        echo ""
        echo "ğŸ’¾ Save these credentials securely!"

  # Template: Test new user connection
  - name: test-user-connection
    inputs:
      parameters:
      - name: db-host
      - name: db-port
      - name: db-name
      - name: username
      - name: password
    container:
      image: postgres:15-alpine
      command: [sh, -c]
      env:
      - name: PGHOST
        value: "{{inputs.parameters.db-host}}"
      - name: PGPORT
        value: "{{inputs.parameters.db-port}}"
      - name: PGDATABASE
        value: "{{inputs.parameters.db-name}}"
      - name: PGUSER
        value: "{{inputs.parameters.username}}"
      - name: PGPASSWORD
        value: "{{inputs.parameters.password}}"
      args:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§ª Testing New User Connection"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Username: $PGUSER"
        echo "Database: $PGDATABASE"
        echo ""
        
        echo "â³ Testing PostgreSQL connection..."
        if psql -c "SELECT current_user, current_database();" > /dev/null 2>&1; then
          echo "âœ… Connection successful!"
          echo ""
          echo "ğŸ“Š User can access database:"
          psql -c "SELECT current_user, current_database();"
          echo ""
          echo "ğŸ“‹ User can list tables:"
          psql -c "\dt" || echo "No tables found (this is OK)"
        else
          echo "âŒ Connection failed!"
          exit 1
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… User connection test completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
