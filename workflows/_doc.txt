cat <<'EOF'

# Create ConfigMap for artifact repository configuration
kubectl apply -n argo -f - <<'YAML'
apiVersion: v1
kind: ConfigMap
metadata:
  name: workflow-controller-configmap
  namespace: argo
data:
  config: |
    artifactRepository:
      archiveLogs: true
      s3:
        bucket: my-bucket
        endpoint: minio:9000
        insecure: true
        accessKeySecret:
          name: my-minio-cred
          key: accesskey
        secretKeySecret:
          name: my-minio-cred
          key: secretkey
YAML

EOF


kubectl apply -n argo -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: workflow-controller-configmap
  namespace: argo
data:
  config: |
    artifactRepository:
      archiveLogs: true
      local:
        path: /tmp/argo-workflows
        nodeSelection:
          selector: {}
EOF


kubectl rollout restart deployment workflow-controller -n argo
kubectl rollout status deployment workflow-controller -n argo --timeout=60s



# Install MinIO
kubectl create namespace minio --dry-run=client -o yaml | kubectl apply -f -
kubectl apply -n minio -f https://raw.githubusercontent.com/minio/minio-operator/master/minio-operator.yaml

# Or use a simple MinIO deployment
kubectl apply -n argo -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
  namespace: argo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: minio
  template:
    metadata:
      labels:
        app: minio
    spec:
      containers:
      - name: minio
        image: minio/minio:latest
        args: ["server", "/data", "--console-address", ":9001"]
        env:
        - name: MINIO_ROOT_USER
          value: "minioadmin"
        - name: MINIO_ROOT_PASSWORD
          value: "minioadmin"
        ports:
        - containerPort: 9000
        - containerPort: 9001
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: minio
  namespace: argo
spec:
  ports:
  - port: 9000
    targetPort: 9000
  - port: 9001
    targetPort: 9001
  selector:
    app: minio
EOF

# Create MinIO credentials secret
kubectl create secret generic my-minio-cred -n argo \
  --from-literal=accesskey=minioadmin \
  --from-literal=secretkey=minioadmin

# Configure Argo Workflows to use MinIO
kubectl apply -n argo -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: workflow-controller-configmap
  namespace: argo
data:
  config: |
    artifactRepository:
      archiveLogs: true
      s3:
        bucket: argo-workflows
        endpoint: minio.argo.svc:9000
        insecure: true
        accessKeySecret:
          name: my-minio-cred
          key: accesskey
        secretKeySecret:
          name: my-minio-cred
          key: secretkey
EOF

# Restart workflow-controller
kubectl rollout restart deployment workflow-controller -n argo






# Delete the broken ConfigMap
kubectl delete configmap workflow-controller-configmap -n argo

# Install MinIO
kubectl apply -n argo -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio
  namespace: argo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: minio
  template:
    metadata:
      labels:
        app: minio
    spec:
      containers:
      - name: minio
        image: minio/minio:latest
        args: ["server", "/data", "--console-address", ":9001"]
        env:
        - name: MINIO_ROOT_USER
          value: "minioadmin"
        - name: MINIO_ROOT_PASSWORD
          value: "minioadmin"
        ports:
        - containerPort: 9000
        - containerPort: 9001
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: minio
  namespace: argo
spec:
  ports:
  - port: 9000
    targetPort: 9000
  selector:
    app: minio
EOF

# Wait for MinIO to be ready
kubectl wait --for=condition=ready pod -l app=minio -n argo --timeout=120s

# Create MinIO credentials secret
kubectl create secret generic my-minio-cred -n argo \
  --from-literal=accesskey=minioadmin \
  --from-literal=secretkey=minioadmin \
  --dry-run=client -o yaml | kubectl apply -f -

# Create ConfigMap with S3 configuration (MinIO is S3-compatible)
kubectl create configmap workflow-controller-configmap -n argo --from-literal=config="artifactRepository:
  archiveLogs: true
  s3:
    bucket: argo-workflows
    endpoint: minio.argo.svc:9000
    insecure: true
    accessKeySecret:
      name: my-minio-cred
      key: accesskey
    secretKeySecret:
      name: my-minio-cred
      key: secretkey"

# Restart workflow-controller
kubectl rollout restart deployment workflow-controller -n argo
kubectl rollout status deployment workflow-controller -n argo --timeout=60s

# Check logs
kubectl logs -n argo -l app=workflow-controller --tail=20



kubectl port-forward -n argo svc/minio 9001:9001


kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/master/config/install.yaml


kubectl port-forward -n sonarqube svc/sonarqube 9000:9000
kubectl apply -f /Volumes/X9Pro/Labs/uabsd/argo-labs/workflows/poller-cronjob.yaml
