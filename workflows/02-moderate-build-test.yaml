apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: moderate-build-test
  namespace: argo
  annotations:
    description: "Moderate workflow - builds Docker image and runs tests, but does NOT push to registry"
spec:
  entrypoint: build-and-test
  
  templates:
  - name: build-and-test
    steps:
    # Step 1: Checkout code
    - - name: checkout
        template: git-clone
        arguments:
          parameters:
          - name: url
            value: "{{workflow.parameters.repo-url}}"
          - name: revision
            value: "{{workflow.parameters.revision}}"
    
    # Step 2: Build and quality checks in parallel
    - - name: build-image
        template: docker-build
        arguments:
          parameters:
          - name: image-name
            value: "{{workflow.parameters.image-name}}"
          - name: image-tag
            value: "{{workflow.name}}"
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
      - name: lint-code
        template: code-lint
        arguments:
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
      - name: security-scan
        template: security-scan-code
        arguments:
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
    
    # Step 3: Run tests with built image
    - - name: integration-tests
        template: test-built-image
        arguments:
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
          - name: image
            from: "{{steps.build-image.outputs.artifacts.image}}"
    
    # Step 4: Generate build report (no push)
    - - name: build-report
        template: generate-build-report
        arguments:
          parameters:
          - name: image-name
            value: "{{workflow.parameters.image-name}}"
          - name: image-tag
            value: "{{workflow.name}}"

  # Git Clone Template
  - name: git-clone
    inputs:
      parameters:
      - name: url
      - name: revision
    container:
      image: alpine/git:latest
      command: [sh, -c]
      args:
      - |
        echo "ğŸ“¥ Cloning repository..."
        git clone {{inputs.parameters.url}} /workspace
        cd /workspace
        git checkout {{inputs.parameters.revision}}
        echo "âœ… Checked out {{inputs.parameters.revision}}"
    outputs:
      artifacts:
      - name: source
        path: /workspace

  # Docker Build Template
  - name: docker-build
    inputs:
      parameters:
      - name: image-name
      - name: image-tag
      artifacts:
      - name: source
        path: /workspace
    container:
      image: docker:dind
      command: [sh, -c]
      args:
      - |
        apk add --no-cache docker-cli
        cd /workspace
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”¨ Building Docker Image"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Check if Dockerfile exists
        if [ ! -f Dockerfile ]; then
          echo "âš ï¸  No Dockerfile found, creating a simple one..."
          cat > Dockerfile <<EOF
        FROM alpine:latest
        RUN apk add --no-cache curl
        WORKDIR /app
        COPY . /app
        CMD ["sh"]
        EOF
        fi
        
        echo "Building {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}}..."
        docker build -t {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}} .
        docker save {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}} -o /tmp/image.tar
        
        # Show image info
        docker images {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}}
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Image built successfully"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      volumeMounts:
      - name: docker-sock
        mountPath: /var/run
      securityContext:
        privileged: true
    outputs:
      artifacts:
      - name: image
        path: /tmp/image.tar
    volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock

  # Code Lint Template
  - name: code-lint
    inputs:
      artifacts:
      - name: source
        path: /workspace
    container:
      image: hadolint/hadolint:latest
      command: [sh, -c]
      args:
      - |
        cd /workspace
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Running Code Linting"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Lint Dockerfile
        if [ -f Dockerfile ]; then
          echo "Linting Dockerfile..."
          hadolint Dockerfile || echo "âš ï¸  Lint warnings found"
        fi
        
        # Check for common code issues
        echo "Checking code quality..."
        find . -name "*.sh" -exec shellcheck {} \; 2>/dev/null || echo "ShellCheck not available"
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Linting completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Security Scan Template
  - name: security-scan-code
    inputs:
      artifacts:
      - name: source
        path: /workspace
    container:
      image: aquasec/trivy:latest
      command: [sh, -c]
      args:
      - |
        cd /workspace
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”’ Running Security Scan"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Scan filesystem
        trivy fs --exit-code 0 --severity HIGH,CRITICAL /workspace || echo "âš ï¸  Security issues found (non-blocking)"
        
        # Scan Dockerfile if exists
        if [ -f Dockerfile ]; then
          echo "Scanning Dockerfile..."
          trivy config Dockerfile || echo "âš ï¸  Dockerfile scan completed"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Security scan completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Test Built Image Template
  - name: test-built-image
    inputs:
      artifacts:
      - name: source
        path: /workspace
      - name: image
        path: /tmp/image.tar
    container:
      image: docker:dind
      command: [sh, -c]
      args:
      - |
        apk add --no-cache docker-cli curl
        docker load -i /tmp/image.tar
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ§ª Testing Built Image"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Get image name from loaded images
        IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -1)
        echo "Testing image: ${IMAGE_NAME}"
        
        # Start container
        CONTAINER_ID=$(docker run -d ${IMAGE_NAME} sleep 30)
        sleep 3
        
        # Run tests
        if docker ps | grep -q $CONTAINER_ID; then
          echo "âœ… Container started successfully"
          echo "Running container tests..."
          docker logs $CONTAINER_ID
          
          # Basic health check
          echo "Performing health checks..."
          docker exec $CONTAINER_ID sh -c "echo 'Health check passed'" || echo "Health check completed"
          
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID
          echo "âœ… Image tests passed"
        else
          echo "âŒ Container failed to start"
          exit 1
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Integration tests completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      volumeMounts:
      - name: docker-sock
        mountPath: /var/run
      securityContext:
        privileged: true
    volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock

  # Generate Build Report Template
  - name: generate-build-report
    inputs:
      parameters:
      - name: image-name
      - name: image-tag
    container:
      image: alpine:latest
      command: [sh, -c]
      args:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Build Report"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Workflow: {{workflow.name}}"
        echo "Image: {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}}"
        echo "Status: {{workflow.status}}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â„¹ï¸  Image built but NOT pushed to registry"
        echo "âœ… Build workflow completed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Workflow Parameters
  arguments:
    parameters:
    - name: repo-url
      value: "https://github.com/gilsonbellon/argo-labs.git"
    - name: revision
      value: "main"
    - name: image-name
      value: "test-app"
