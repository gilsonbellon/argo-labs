apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: simple-build-test
  namespace: argo
  annotations:
    description: "Simple build and test workflow - builds Docker image and runs basic tests, does NOT push to registry"
spec:
  entrypoint: build-and-test
  
  templates:
  - name: build-and-test
    steps:
    # Step 1: Checkout code
    - - name: checkout
        template: git-clone
    
    # Step 2: Build Docker image
    - - name: build
        template: docker-build
        arguments:
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
    
    # Step 3: Run tests
    - - name: test
        template: run-tests
        arguments:
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
          - name: image
            from: "{{steps.build.outputs.artifacts.image}}"

  # Git Clone Template
  - name: git-clone
    inputs:
      parameters:
      - name: url
        default: "https://github.com/gilsonbellon/argo-labs.git"
      - name: revision
        default: "main"
    container:
      image: alpine/git:latest
      command: [sh, -c]
      args:
      - |
        echo "ðŸ“¥ Cloning repository..."
        git clone {{inputs.parameters.url}} /workspace
        cd /workspace
        git checkout {{inputs.parameters.revision}}
        echo "âœ… Checked out {{inputs.parameters.revision}}"
    outputs:
      artifacts:
      - name: source
        path: /workspace

  # Docker Build Template
  - name: docker-build
    inputs:
      parameters:
      - name: image-name
        default: "test-app"
      - name: image-tag
        default: "latest"
      artifacts:
      - name: source
        path: /workspace
    container:
      image: docker:dind
      command: [sh, -c]
      args:
      - |
        apk add --no-cache docker-cli
        cd /workspace
        
        echo "ðŸ”¨ Building Docker image..."
        
        # Check if Dockerfile exists
        if [ ! -f Dockerfile ]; then
          echo "âš ï¸  No Dockerfile found, creating a simple one..."
          cat > Dockerfile <<EOF
        FROM alpine:latest
        RUN apk add --no-cache curl
        WORKDIR /app
        COPY . /app
        CMD ["sh"]
        EOF
        fi
        
        docker build -t {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}} .
        docker save {{inputs.parameters.image-name}}:{{inputs.parameters.image-tag}} -o /tmp/image.tar
        echo "âœ… Image built successfully"
      volumeMounts:
      - name: docker-sock
        mountPath: /var/run
      securityContext:
        privileged: true
    outputs:
      artifacts:
      - name: image
        path: /tmp/image.tar
    volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock

  # Run Tests Template
  - name: run-tests
    inputs:
      parameters:
      - name: image-name
        default: "test-app"
      - name: image-tag
        default: "latest"
      artifacts:
      - name: source
        path: /workspace
      - name: image
        path: /tmp/image.tar
    container:
      image: docker:dind
      command: [sh, -c]
      args:
      - |
        apk add --no-cache docker-cli curl
        docker load -i /tmp/image.tar
        
        echo "ðŸ§ª Running tests..."
        
        # Get image name from loaded images
        IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -1)
        echo "Testing image: ${IMAGE_NAME}"
        
        # Start container and test
        CONTAINER_ID=$(docker run -d ${IMAGE_NAME} sleep 30)
        sleep 2
        
        # Basic health check
        if docker ps | grep -q $CONTAINER_ID; then
          echo "âœ… Container started successfully"
          docker logs $CONTAINER_ID
          docker stop $CONTAINER_ID
          docker rm $CONTAINER_ID
          echo "âœ… Tests passed"
        else
          echo "âŒ Container failed to start"
          exit 1
        fi
      volumeMounts:
      - name: docker-sock
        mountPath: /var/run
      securityContext:
        privileged: true
    volumes:
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock

  # Workflow Parameters
  arguments:
    parameters:
    - name: repo-url
      value: "https://github.com/gilsonbellon/argo-labs.git"
    - name: revision
      value: "main"
    - name: image-name
      value: "test-app"
