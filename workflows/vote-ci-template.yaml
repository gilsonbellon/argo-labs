apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: vote-ci-template
  namespace: argo
  annotations:
    description: "CI pipeline for vote app - builds and pushes Docker images to Harbor registry"
spec:
  entrypoint: vote-ci-pipeline
  serviceAccountName: argo-workflow
  
  templates:
  - name: vote-ci-pipeline
    steps:
    # Step 1: Checkout source code
    - - name: checkout
        template: git-clone
        arguments:
          parameters:
          - name: repo-url
            value: "{{workflow.parameters.repo-url}}"
          - name: branch
            value: "{{workflow.parameters.branch}}"
    
    # Step 2: Build Docker image
    - - name: build
        template: docker-build
        arguments:
          parameters:
          - name: dockerfile
            value: "{{workflow.parameters.dockerfile}}"
          artifacts:
          - name: source
            from: "{{steps.checkout.outputs.artifacts.source}}"
    
    # Step 3: Push to Harbor
    - - name: push-harbor
        template: push-to-harbor
        arguments:
          parameters:
          - name: image
            value: "{{workflow.parameters.image}}"
          - name: tag
            value: "{{workflow.name}}"
          artifacts:
          - name: image
            from: "{{steps.build.outputs.artifacts.image}}"

  # Git Clone Template
  - name: git-clone
    inputs:
      parameters:
      - name: repo-url
      - name: branch
    container:
      image: alpine/git:latest
      command: [sh, -c]
      args:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¥ Cloning Repository"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Repository: {{inputs.parameters.repo-url}}"
        echo "Branch: {{inputs.parameters.branch}}"
        
        # Create workspace directory first
        mkdir -p /workspace
        
        # Clone repository
        if ! git clone {{inputs.parameters.repo-url}} /workspace; then
          echo "âŒ Git clone failed!"
          exit 1
        fi
        
        # Handle GitHub ref format (refs/heads/main -> main)
        BRANCH="{{inputs.parameters.branch}}"
        BRANCH=$(echo "$BRANCH" | sed 's|refs/heads/||')
        
        cd /workspace
        if ! git checkout "$BRANCH"; then
          echo "âŒ Failed to checkout branch: $BRANCH"
          exit 1
        fi
        
        echo "âœ… Checked out branch: $BRANCH"
        echo "ğŸ“‹ Latest commit: $(git log -1 --oneline)"
        
        # Ensure workspace exists and has content for artifact archiving
        echo "ğŸ“ Workspace contents:"
        ls -la /workspace | head -10
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    outputs:
      artifacts:
      - name: source
        path: /workspace

  # Docker Build Template
  - name: docker-build
    inputs:
      parameters:
      - name: dockerfile
        default: "Dockerfile"
      artifacts:
      - name: source
        path: /workspace
    container:
      image: docker:dind
      command: [sh, -c]
      args:
      - |
        # Start Docker daemon
        dockerd-entrypoint.sh &
        sleep 5
        
        # Wait for Docker daemon to be ready
        until docker info >/dev/null 2>&1; do
          echo "Waiting for Docker daemon..."
          sleep 1
        done
        
        apk add --no-cache docker-cli
        cd /workspace
        
        DOCKERFILE="{{inputs.parameters.dockerfile}}"
        IMAGE_NAME="build-image"
        IMAGE_TAG="{{workflow.name}}"
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”¨ Building Docker Image"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“„ Dockerfile: ${DOCKERFILE}"
        
        # Check if Dockerfile exists
        if [ ! -f "${DOCKERFILE}" ]; then
          echo "âŒ Dockerfile not found at ${DOCKERFILE}"
          exit 1
        fi
        
        # Build the image
        docker build -f ${DOCKERFILE} -t ${IMAGE_NAME}:${IMAGE_TAG} .
        
        # Verify image was created
        if ! docker images ${IMAGE_NAME}:${IMAGE_TAG} | grep -q ${IMAGE_NAME}; then
          echo "âŒ Image was not created"
          exit 1
        fi
        
        # Save image to artifact
        echo "Saving image to /tmp/image.tar..."
        if ! docker save ${IMAGE_NAME}:${IMAGE_TAG} -o /tmp/image.tar; then
          echo "âŒ Failed to save image"
          exit 1
        fi
        
        # Verify tar file was created
        if [ ! -f /tmp/image.tar ]; then
          echo "âŒ Image tar file was not created"
          exit 1
        fi
        
        FILE_SIZE=$(du -h /tmp/image.tar | cut -f1)
        echo "âœ… Image tar created: /tmp/image.tar (${FILE_SIZE})"
        docker images ${IMAGE_NAME}:${IMAGE_TAG}
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Image built successfully"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      securityContext:
        privileged: true
    outputs:
      artifacts:
      - name: image
        path: /tmp/image.tar

  # Push to Harbor Template
  - name: push-to-harbor
    inputs:
      parameters:
      - name: image
      - name: tag
      artifacts:
      - name: image
        path: /workspace/image.tar
    container:
      image: docker:dind
      command: [sh, -c]
      args:
      - |
        # Start Docker daemon
        dockerd-entrypoint.sh &
        sleep 5
        
        # Wait for Docker daemon to be ready
        until docker info >/dev/null 2>&1; do
          echo "Waiting for Docker daemon..."
          sleep 1
        done
        
        apk add --no-cache docker-cli curl
        
        # Harbor configuration (same as 04-harbor-build-push.yaml)
        HARBOR_REGISTRY="harborngp.34-147-139-99.sslip.io"
        HARBOR_PROJECT="gil-test"
        IMAGE_NAME="{{inputs.parameters.image}}"
        TAG="{{inputs.parameters.tag}}"
        FULL_IMAGE="${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${TAG}"
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ Pushing to Harbor Registry"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Registry: ${HARBOR_REGISTRY}"
        echo "Project: ${HARBOR_PROJECT}"
        echo "Image: ${IMAGE_NAME}"
        echo "Tag: ${TAG}"
        echo "Full Image: ${FULL_IMAGE}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Verify artifact exists
        if [ ! -f /workspace/image.tar ]; then
          echo "âŒ Error: /workspace/image.tar not found!"
          exit 1
        fi
        
        # Load image
        echo "ğŸ“¦ Loading image..."
        docker load -i /workspace/image.tar
        
        # Get the original image name
        ORIGINAL_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -1)
        echo "ğŸ“‹ Original image: ${ORIGINAL_IMAGE}"
        
        # Tag for Harbor
        echo "ğŸ·ï¸  Tagging image as ${FULL_IMAGE}"
        docker tag ${ORIGINAL_IMAGE} ${FULL_IMAGE}
        
        # Verify tag
        docker images | grep "${HARBOR_PROJECT}/${IMAGE_NAME}"
        
        # Login to Harbor
        echo "ğŸ” Logging into Harbor..."
        
        # Get token from secret or parameter
        if [ -f /var/secrets/harbor/username ] && [ -f /var/secrets/harbor/password ]; then
          HARBOR_USER=$(cat /var/secrets/harbor/username)
          HARBOR_PASS=$(cat /var/secrets/harbor/password)
          echo "âœ… Using credentials from Kubernetes secret"
        elif [ -n "${{workflow.parameters.harbor-username}}" ] && [ -n "${{workflow.parameters.harbor-password}}" ]; then
          HARBOR_USER="${{workflow.parameters.harbor-username}}"
          HARBOR_PASS="${{workflow.parameters.harbor-password}}"
          echo "âœ… Using credentials from workflow parameters"
        else
          echo "âŒ Harbor credentials not provided"
          exit 1
        fi
        
        echo "$HARBOR_PASS" | docker login ${HARBOR_REGISTRY} -u "$HARBOR_USER" --password-stdin
        
        # Push to Harbor
        echo "ğŸš€ Pushing ${FULL_IMAGE} to Harbor..."
        docker push ${FULL_IMAGE}
        
        if [ $? -eq 0 ]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Successfully pushed to Harbor!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image: ${FULL_IMAGE}"
          echo "ğŸ”— Pull command: docker pull ${FULL_IMAGE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo "âŒ Failed to push to Harbor"
          exit 1
        fi
      volumeMounts:
      - name: harbor-secret
        mountPath: /var/secrets/harbor
        readOnly: true
      securityContext:
        privileged: true
    volumes:
    - name: harbor-secret
      secret:
        secretName: harbor-credentials
        optional: true

  # Workflow Parameters
  arguments:
    parameters:
    - name: repo-url
      value: "https://github.com/xxxxxx/vote.git"
    - name: branch
      value: "main"
    - name: image
      value: "vote"
    - name: dockerfile
      value: "Dockerfile"
    - name: harbor-username
      value: ""  # Optional - will use secret if not provided
    - name: harbor-password
      value: ""  # Optional - will use secret if not provided
